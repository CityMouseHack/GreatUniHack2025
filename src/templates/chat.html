{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2>Chat with {{ partner }}</h2>
    <div id="messages" style="height: 400px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;">
        {% for message in messages %}
            <div class="message">
                <strong>{{ message.sender_id }}:</strong> {{ message.content }}
                <span class="timestamp" style="font-size: 0.8em; color: #888;">{{ message.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</span>
            </div>
        {% endfor %}
    </div>
    <form method="POST" action="">
        {{ form.hidden_tag() }}
        <div class="form-group">
            {{ form.message.label(class="form-control-label") }}
            {{ form.message(class="form-control") }}
        </div>
        <div class="form-group">
            {{ form.submit(class="btn btn-primary") }}
        </div>
    </form>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', (event) => {
        var socket = io.connect('http://' + document.domain + ':' + location.port);

        var conversationId = "{{ conversation_id }}";

        socket.on('connect', function() {
            socket.emit('join', {room: conversationId});
        });

        socket.on('new_message', function(msg) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');

            const senderStrong = document.createElement('strong');
            senderStrong.textContent = msg.sender_id + ': ';
            messageDiv.appendChild(senderStrong);

            messageDiv.append(msg.content);

            const timestampSpan = document.createElement('span');
            timestampSpan.classList.add('timestamp');
            timestampSpan.style.fontSize = '0.8em';
            timestampSpan.style.color = '#888';
            let messageTimestamp = new Date(msg.timestamp);
            timestampSpan.textContent = ' ' + messageTimestamp.toLocaleString();
            messageDiv.appendChild(timestampSpan);
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });

        window.onbeforeunload = function() {
            socket.emit('leave', {room: conversationId});
        };
    });
</script>
{% endblock %}